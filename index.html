<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="plugins/jsPsych7.3/jspsych.css">
    <link rel="icon" type="image/png" href="favicon.png">

    <style>
        .jspsych-btn {
            margin-bottom: 10px;
        }

        .jspsych-instructions-nav {
            margin-bottom: 100px;
        }

        #consentDiv {
            font-size: 9pt;
            text-align: justify;
        }
    </style>

    <script src="plugins/jsPsych7.3/jspsych.js"></script>
    <script src="plugins/jsPsych7.3/plugin-survey-text.js"></script>
    <script src="plugins/jsPsych7.3/plugin-html-slider-response.js"></script>
    <script src="plugins/jsPsych7.3/plugin-html-keyboard-response.js"></script>
    <script src="plugins/jsPsych7.3/plugin-html-button-response.js"></script>
    <script src="plugins/jsPsych7.3/plugin-canvas-button-response.js"></script>
    <script src="plugins/jsPsych7.3/plugin-external-html.js"></script>
    <script src="plugins/jsPsych7.3/plugin-instructions.js"></script>
    <script src="plugins/jsPsych7.3/plugin-survey-multi-choice.js"></script>
    <script src="plugins/jsPsych7.3/plugin-fullscreen.js"></script>
    <script src="plugins/jsPsych7.3/plugin-preload.js"></script>
    <script src="plugins/jsPsych7.3/plugin-call-function.js"></script>
    <script src="plugins/plugin-survey-template.js"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe@0.4"></script>
    <script src="plugins/plugin-ensemble-flashing.js"></script>
    <script src="plugins/jspsych-continuous-color-wm.js"></script>
    <script src="surveys/docs_updated.js"></script>
    <script src="surveys/phq4.js"></script>
    <script src="surveys/bcis.js"></script>
    <script src="surveys/msas.js"></script>
</head>
<body>
    <script>

// 1. INITIALIZE JSPSYCH (Once at the top)
var jsPsych = initJsPsych({
    show_progress_bar: true,
    auto_update_progress_bar: true,
    message_progress_bar: "Progress on entire study:",
    on_finish: function() {
        // Optional: Local save or redirect
        // window.location.href = "https://ucsd.sona-systems.com...";
    }
});

// ---------------------------------------------------------
// SETTINGS
// ---------------------------------------------------------
const TRAINING_TRIALS = 5; 
const MAIN_TRIALS = 70;     // 
const WM_SET_SIZE = 5;
const NUM_FIXED = 121;       // Fixed numerosity dots
const IMG_A = "assets/black-berry-dark.png";
const IMG_B = "assets/raspberry.png";

const subject_id = jsPsych.randomization.randomID(10);
const filename = `${subject_id}.csv`;

// ---------------------------------------------------------
// COLOR CONVERSION HELPERS
// ---------------------------------------------------------

function lab2rgb(lab){
  var y = (lab[0] + 16) / 116,
      x = lab[1] / 500 + y,
      z = y - lab[2] / 200,
      r, g, b;

  x = 0.95047 * ((x * x * x > 0.008856) ? x * x * x : (x - 16/116) / 7.787);
  y = 1.00000 * ((y * y * y > 0.008856) ? y * y * y : (y - 16/116) / 7.787);
  z = 1.08883 * ((z * z * z > 0.008856) ? z * z * z : (z - 16/116) / 7.787);

  r = x * 3.2406 + y * -1.5372 + z * -0.4986;
  g = x * -0.9689 + y * 1.8758 + z * 0.0415;
  b = x * 0.0557 + y * -0.2040 + z * 1.0570;

  r = (r > 0.0031308) ? (1.055 * Math.pow(r, 1 / 2.4) - 0.055) : 12.92 * r;
  g = (g > 0.0031308) ? (1.055 * Math.pow(g, 1 / 2.4) - 0.055) : 12.92 * g;
  b = (b > 0.0031308) ? (1.055 * Math.pow(b, 1 / 2.4) - 0.055) : 12.92 * b;

  return "rgb(" + (Math.max(0, Math.min(1, r)) * 255) + "," + 
         (Math.max(0, Math.min(1, g)) * 255) + "," + 
         (Math.max(0, Math.min(1, b)) * 255) + ")";
}

function getColor(n) {
    var a = n;
    var b = 40; // Fixed chroma
    var radius = 60; // Fixed lightness
    var deg2rad = Math.PI / 180;
    var a_lab = Math.cos(a * deg2rad) * b;
    var b_lab = Math.sin(a * deg2rad) * b;
    // L=70 is standard for this task usually, adjusting based on common lab color wheels
    return lab2rgb([70, a_lab, b_lab]); 
}

function ColToRGB(n) {
  if(Array.isArray(n)){
    var cols = [];
    for(var i=0; i<n.length; i++){
      cols.push(getColor(n[i]));
    }
    return cols;
  } else {
    return getColor(n);
  }
}

// Capture Subject ID
var subjectID = jsPsych.data.getURLVariable('id') || jsPsych.randomization.randomID(8);
jsPsych.data.addProperties({subject_id: subjectID});

// Helper functions for VWM
function getRandomIntInclusive(min, max) {
    min = Math.ceil(min); max = Math.floor(max);
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
function wrap(v) {
    if (Array.isArray(v)) {
        for (var i=0; i<v.length; i++) {
            if (v[i]>=360) { v[i]-=360; }
            if (v[i]<0) { v[i]+=360; }
        }
    } else {
        if (v>=360) { v-=360; }
        if (v<0) { v+=360; }
    }
    return v;
}
// --- Math Helper for Numerosity ---
function randomNormal(mean, sd) {
    let u = 0, v = 0;
    while(u === 0) u = Math.random(); 
    while(v === 0) v = Math.random();
    let num = Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
    return num * sd + mean;
}
// --- Break Screen ---
function getBreakTrial() {
    return {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <div class="break-text">
                <p>Block Complete!</p>
                <p>Please take a short break (up to 30 seconds).</p>
            </div>
        `,
        choices: ['Continue'],
        trial_duration: 30000,
        response_ends_trial: true
    };
}

// --- Numerosity Generator ---
function createNumerosityBlock(numTrials, timing, isTraining) {
    var block_timeline = [];
    var block_label = isTraining ? 'Num_Training' : 'Num_Main';

    for (var i = 0; i < numTrials; i++) {
        var n = NUM_FIXED;
        
        // Sample Proportion from Normal Distribution (Mean 0.5, SD 0.05)
        // Keep picking a new number until it falls inside 0.40 and 0.60 and not 0.50
        var p;
        do {
            p = randomNormal(0.5, 0.05); 
        } while (p < 0.40 || p > 0.60 || Math.abs(p - 0.5) < 0.01);

        var correct_resp = (p > 0.5) ? 'left' : 'right';

        block_timeline.push({
            type: jsPsychNumerosityEstimationEnsemble,
            stimulus: IMG_A,
            stimulus2: IMG_B,
            proportion_stim1: p,
            numerosity: n,
            left_image: IMG_A,
            right_image: IMG_B,
            stimulus_duration: 1000,
            number_of_frames: 4,
            confidence_timing: timing, 
            feedback: isTraining,      
            correct_response: correct_resp,
            data: { 
                task: block_label, 
                block_type: timing, 
                proportion: p 
            }
        });
    }
    return { timeline: block_timeline };
}

// --- WM Generator ---
function createWMBlock(numTrials, timing, isTraining) {
    var block_timeline = [];
    var block_label = isTraining ? 'WM_Training' : 'WM_Main';
    // Map 'before'/'after' simple strings to plugin specific strings
    var plugin_timing = (timing === 'before') ? 'before_stimuli' : 'after_probe';

    for(let i=0; i<numTrials; i++) {
        block_timeline.push({
            type: jsPsychContinuousColorWM,
            set_size: WM_SET_SIZE,
            num_placeholders: 5,
            confidence_timing: plugin_timing,
            feedback: isTraining,
            display_time: 500,
            min_difference: 30,
            color_wheel_num_options: 2, 
            data: { 
                task: block_label, 
                block_type: timing
            }
        });
    }
    return { timeline: block_timeline };
}

// Helper to bundle Instructions + Training + Main + Break
function buildTaskUnit(taskName, timing) {
    var unit = [];
    var isPre = (timing === 'before');
    var timeLabel = isPre ? "You will need to rate your confidence of your judgment BEFORE the trial" : "You will need to rate your confidence of your judgment AFTER the trial";
    var task_block_inst_ = taskName === 'WM' ? "In this memory task, you will be presented with coloured circles that you need to remember. After a brief delay, you will need to choose the previously seen color (highlighted with thick black circle) from two alternatives. TO START EACH TRIAL YOU WILL NEED TO CLICK A BLACK CROSS IN THE CENTER." : "In this perception task, you will be presented with two different sets of berries simultaneously. After a brief delay, you will need to choose red or blue berry depending on which of had higher numbers.";
    // 1. Instructions
    unit.push({
        type: jsPsychInstructions,
        pages: [
            `<p><strong>${taskName.toUpperCase()} TASK - ${timeLabel}</strong></p>
             <p>${task_block_inst_}</p>
             <p>We will start with ${TRAINING_TRIALS} practice trials with feedback.</p>
             <p>Click Next to begin training.</p>`
        ],
        show_clickable_nav: true
    });

    // 2. Training Block
    if(taskName === 'WM') {
        unit.push(createWMBlock(TRAINING_TRIALS, timing, true));
    } else {
        unit.push(createNumerosityBlock(TRAINING_TRIALS, timing, true));
    }

    // 3. Main Block Intro
    unit.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `<p>Practice complete.</p><p>Starting the <strong>Main Block</strong> (${MAIN_TRIALS} trials).</p><p>Feedback is now OFF.</p>`,
        choices: ['Start Main Block']
    });

    // 4. Main Block
    if(taskName === 'WM') {
        unit.push(createWMBlock(MAIN_TRIALS, timing, false));
    } else {
        unit.push(createNumerosityBlock(MAIN_TRIALS, timing, false));
    }

    // 5. Break
    unit.push(getBreakTrial());

    return unit;
}

// Generate 'before' maps to Prediction, 'after' maps to Postdiction
var unit_WM_Pre   = buildTaskUnit('WM', 'before');
var unit_Num_Pre  = buildTaskUnit('Numerosity', 'before');
var unit_WM_Post  = buildTaskUnit('WM', 'after');
var unit_Num_Post = buildTaskUnit('Numerosity', 'after');


// RANDOMIZATION LOGIC
// =========================================================================

// A. Shuffle the order of tasks within the "Pre" phase
var pre_phase_blocks = [unit_WM_Pre, unit_Num_Pre];
pre_phase_blocks = jsPsych.randomization.shuffle(pre_phase_blocks); 
var pre_phase_timeline = [].concat(...pre_phase_blocks);

// B. Shuffle the order of tasks within the "Post" phase
var post_phase_blocks = [unit_WM_Post, unit_Num_Post];
post_phase_blocks = jsPsych.randomization.shuffle(post_phase_blocks);
var post_phase_timeline = [].concat(...post_phase_blocks);

// C. Shuffle the global order (Pre-then-Post OR Post-then-Pre)
var global_phases = [
    { type: 'Pre', timeline: pre_phase_timeline },
    { type: 'Post', timeline: post_phase_timeline }
];
global_phases = jsPsych.randomization.shuffle(global_phases);

// ---------------------------------------------------------
// Consent Form
// ---------------------------------------------------------
var consent_trial = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
    <div style="text-align: left; max-width: 800px; margin: auto; font-size: 16px;">
        <h3>Consent to Participate</h3>
        <p>
            <strong>Study Purpose:</strong> We are conducting research on memory and perception.
        </p>
        <p>
            <strong>Procedure:</strong> In this task, you will be asked to remember simple stimuli.
        </p>
        <p>
            In the memory task, you will be presented with a set of colored circles. After a brief delay, you will need to choose the previously seen color from two alternatives.
        </p>
        <p>
            In the perception task, you will be presented with two different sets of stimuli simultaneously. After a brief delay, you will need to choose one of the two sets in which you think more stimuli had been shown.
        </p>
        <p>
            The task will take approximately 30-40 minutes.
        </p>
        <p>
            <strong>Rights:</strong> Your participation is voluntary. You may stop at any time without penalty.
            Your data will be anonymous and used for research purposes only.
        </p>
        <p>
            <strong>Contact:</strong> If you have questions, please contact the researcher.
        </p>
        <p style="text-align: center; font-weight: bold; margin-top: 20px;">
            By clicking "I Agree" below, you confirm that you are at least 18 years old and consent to participate.
        </p>
    </div>
    `,
    choices: ['I Agree', 'I Do Not Agree'],
    on_finish: function(data){
        if(data.response == 1){
            jsPsych.endExperiment('You chose not to participate. You may close this window.');
        }
    }
};

var questionnaire_inst = {
    type: jsPsychInstructions,
            pages: [
                '<p><strong>Now you will need to answer a set of questions about your metacognition in everyday life</strong></p>' +
                '<p>Please answer them accurately.</p>' +
                '<p>This part will take approximately 10 minutes.</p>' +
                '<p>Thank you for your participation!</p>' 
            ],
    show_clickable_nav: true
};


// DATA SAVING 
const save_data = {
            type: jsPsychPipe,
            action: "save",
            experiment_id: "QLxQcn14z3FJ",
            filename: filename,
            data_string: () => jsPsych.data.get().csv()
        };
var endDebriefing = {
            type: jsPsychInstructions,
            pages: [
                `p>Thank you very much for your participation. The purpose of this study was to examine how metacognitive judgments change depending on the type of task and to also investigate individual differences in variation. We are focusing on how individual differences in metacognitive insight within the general population influence the calibration of confidence judgments across perceptual and memory tasks. We plan to utilize a combination of computational models to quantify potential individual differences in behavioral performance during the task.
                <p><b>Your data has been saved</b> on our servers, so you are free to close this window whenever you want. Thanks again!</p>`
            ],
            button_label_next: "Clear this screen",
            show_clickable_nav: true
        };


// ---------------------------------------------------------
// MASTER TIMELINE
// ---------------------------------------------------------
var timeline = [];
     
// Consent
timeline.push(consent_trial);

// Fullscreen
timeline.push({ type: jsPsychFullscreen, fullscreen_mode: true });

// PUSH BLOCKS 
timeline = timeline.concat(global_phases[0].timeline);
timeline = timeline.concat(global_phases[1].timeline);   

// Questionnaires
timeline.push(questionnaire_inst);
timeline.push({
    type: jsPsychSurveyDOCS
});
timeline.push(phq4);
timeline.push(bcis);
timeline.push(msas_a);
timeline.push(msas_b);
timeline.push(msas_c);
timeline.push(msas_d);

// Save & Exit
timeline.push(save_data);
// Debrief
timeline.push({ type: jsPsychFullscreen, fullscreen_mode: false });
timeline.push(endDebriefing);
// Run
jsPsych.run(timeline);

    </script>
</body>
</html>